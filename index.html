<!DOCTYPE html >
<html lang="pt-br" manifest="test.appcache">
<head>
	<meta charset="UTF-8">
	<link rel="manifest" href="manifest.json">
	<title>MVP - Checklist</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="style.css">
	<script src="placas.json"></script>
	<script src="checklist.json"></script>

	
	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="bower_components/twitter-bootstrap-wizard/jquery.bootstrap.wizard.min.js"></script>
</head>
<body>
	<div class="container" style="max-width: 600px;">
		<div class="row" style="text-align: center;">
			<h2>Checklist</h2>
			<h4 id="status_rede"> conectado </h4>
		</div>
		<div class="row">
			<div class="col-xs-12">
			<div id="rootwizard" class="tabbable tabs-left">
				<ul>
				  	<li><a href="#tab1" data-toggle="tab">Informações</a></li>
					<li><a href="#tab2" data-toggle="tab">Condutor</a></li>
					<li><a href="#tab3" data-toggle="tab">Veículo</a></li>
					<li><a href="#tab4" data-toggle="tab">Freio</a></li>
					<li><a href="#tab5" data-toggle="tab">Setas</a></li>
					<li><a href="#tab6" data-toggle="tab">Setas</a></li>
					<li><a href="#tab7" data-toggle="tab">Finalizar</a></li>
				</ul>
				
				<div class="tab-content">
				    <div class="tab-pane" id="tab1">
				    	<div class="row">
				    		<div class="col-xs-12">
				    			<h2 class="title">Informações do veículo.</h2>
				    		</div>
				    		<div class="col-xs-6">
				    			<select id="tipo_carga" name="tipo_carga" onChange="carrega_placas();">
									<option value="0" selected="selected"> - Escolha um tipo de carga - </option>
									<option value="1"> Produto Acabado - Truck</option>
									<option value="2"> Produto Acabado - Bitruck </option>
									<option value="3"> Produto Acabado - Toco</option>
								</select>
				    		</div>
				    		<div class="col-xs-6">
				    			<div id="placa_input" style="display:none;">
									<select id="placa" name="placa">		
									</select>
								</div>
				    		</div>
				    	</div>
				    </div>
				    <div class="tab-pane" id="tab2">
				    	<div class="row">
				    		<div class="col-xs-12">
				    			<h2 class="title">Documentos do condutor</h2>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option ok" data-tag="DOCUMENTO_CONDUTOR">
				    				OK
				    			</button>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option error" data-tag="DOCUMENTO_CONDUTOR">
				    				(X)
				    			</button>
				    		</div>
				    		<div class="col-xs-12">
				    			
				    			<div class="error_block DOCUMENTO_CONDUTOR">
				    				<h3>Problemas com documento.</h3>
				    				<select id="error_description_DOCUMENTO_CONDUTOR" name="error_description_DOCUMENTO_CONDUTOR" class="error_description" data-tag="DOCUMENTO_CONDUTOR">
				    					<option value="0"> - Marque uma opção - </option>
										<option value="Documento não se encontra."> Documento não se encontra</option>
										<option value="Documento vencido"> Documento vencido </option>
										<option value="Documento rasgado"> Documento rasgado</option>
									</select>
				    			</div>
				    		</div>
				    	</div>
				    </div>
					<div class="tab-pane" id="tab3">
						<div class="row">
				    		<div class="col-xs-12">
				    			<h2 class="title">Documentos do veículo</h2>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option ok" data-tag="DOCUMENTO_VEICULO">
				    				OK
				    			</button>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option error" data-tag="DOCUMENTO_VEICULO">
				    				(X)
				    			</button>
				    		</div>
				    		<div class="col-xs-12">
				    			
				    			<div class="error_block DOCUMENTO_VEICULO">
				    				<h3>Problemas com documento veiculo.</h3>
				    				<select id="error_description_DOCUMENTO_VEICULO" name="error_description_DOCUMENTO_VEICULO" class="error_description" data-tag="DOCUMENTO_VEICULO">
				    					<option value="0"> - Marque uma opção - </option>
										<option value="Documento não se encontra."> Documento não se encontra</option>
										<option value="Documento vencido"> Documento vencido </option>
										<option value="Documento rasgado"> Documento rasgado</option>
									</select>
				    			</div>
				    		</div>
				    	</div>
				    </div>
					<div class="tab-pane" id="tab4">
						<div class="row">
				    		<div class="col-xs-12">
				    			<h2 class="title">LUZ_FREIO</h2>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option ok" data-tag="LUZ_FREIO">
				    				OK
				    			</button>
				    		</div>
				    		<div class="col-xs-6">
				    			<button class="option error" data-tag="LUZ_FREIO">
				    				(X)
				    			</button>
				    		</div>
				    		<div class="col-xs-12">
				    			
				    			<div class="error_block LUZ_FREIO">
				    				<h3>Problemas com luz de freio</h3>
				    				<select id="error_description_LUZ_FREIO" name="error_description_LUZ_FREIO" class="error_description" data-tag="LUZ_FREIO">
				    					<option value="0"> - Marque uma opção - </option>
										<option value="Luz está quebrada."> Luz está quebrada</option>
										<option value="Luz está queimada."> Luz está queimada </option>
									</select>
				    			</div>
				    		</div>
				    	</div>
				    </div>
					<div class="tab-pane" id="tab5">
							<div class="row">
					    		<div class="col-xs-12">
					    			<h2 class="title">SETAS_DIANTEIRAS</h2>
					    		</div>
					    		<div class="col-xs-6">
					    			<button class="option ok" data-tag="SETAS_DIANTEIRAS">
					    				OK
					    			</button>
					    		</div>
					    		<div class="col-xs-6">
					    			<button class="option error" data-tag="SETAS_DIANTEIRAS">
					    				(X)
					    			</button>
					    		</div>
					    		<div class="col-xs-12">
					    			
					    			<div class="error_block SETAS_DIANTEIRAS">
					    				<h3>Problemas com setas.</h3>
					    				<select id="error_description_SETAS_DIANTEIRAS" name="error_description_SETAS_DIANTEIRAS" class="error_description" data-tag="SETAS_DIANTEIRAS">
					    					<option value="0"> - Marque uma opção - </option>
											<option value="Luz está quebrada."> Luz está quebrada</option>
											<option value="Luz está queimada."> Luz está queimada </option>
										</select>
					    			</div>
					    		</div>
					    	</div>
					  
				    </div>
					<div class="tab-pane" id="tab6">
						
							<div class="row">
					    		<div class="col-xs-12">
					    			<h2 class="title">SETAS_TRASEIRAS</h2>
					    		</div>
					    		<div class="col-xs-6">
					    			<button class="option ok" data-tag="SETAS_TRASEIRAS">
					    				OK
					    			</button>
					    		</div>
					    		<div class="col-xs-6">
					    			<button class="option error" data-tag="SETAS_TRASEIRAS">
					    				(X)
					    			</button>
					    		</div>
					    		<div class="col-xs-12">
					    			
					    			<div class="error_block SETAS_TRASEIRAS">
					    				<h3>Problemas com setas.</h3>
					    				<select id="error_description_SETAS_TRASEIRAS" name="error_description_SETAS_TRASEIRAS" class="error_description" data-tag="SETAS_TRASEIRAS">
					    					<option value="0"> - Marque uma opção - </option>
											<option value="Luz está quebrada."> Luz está quebrada</option>
											<option value="Luz está queimada."> Luz está queimada </option>
										</select>
					    			</div>
					    		</div>
					    	</div>

				    </div>
					<div class="tab-pane" id="tab7">
						<div class="row">
							<div id="resume"></div>
						</div>
						<div class="row">

					    		<button id="salvar" class="btn btn-primary">Salvar</button>
					    	</div>
				    </div>
					<ul class="pager wizard">
						<li class="previous first" style="display:none;"><a href="#">First</a></li>
						<li class="previous"><a href="#">Previous</a></li>
						<li class="next last" style="display:none;"><a href="#">Last</a></li>
					  	<li class="next"><a href="#">Next</a></li>
					</ul>
				</div>
			</div>
			</div>
		</div>
	</div>
	
	<script>
	var checkNow
	var waitingList = []
	var erroBlock = true;
	//wizard with options and events
	$(document).ready(function() {
			//verifica se tem conexão
			if(navigator.onLine) {
				$('#status_rede').text('Você está online!');
				//Verifica se tem objetos salvos em localStorage.

				if(localStorage.waitingList){
					waitingList = JSON.parse(localStorage.waitingList);
					//vê se tem checklist pendentes e envia p/ API
					if(waitingList.itens.length > 0){

						/*
							EM PRODUÇÃO:
							Quando o usuário retornar a conexão com a internet, todos os checklist criados
							enquanto offline devem ser enviadas a rivelli.

							Neste trecho é onde devemos percorrer toda a lista de espera (waitingList) e realizar um 
							$.POST enviando as informações.

						*/


						alert('\n\n\n\n\n\nVocê fez '+waitingList.itens.length+' cadastros offline. \n\n Vamos enviar essas informações...\n\n\n\n\n\n');

						//zera pois ja enviamos.
						waitingList.itens = [];

						//zera o localStorage. Escreve o obj sem itens 
						localStorage.setItem("waitingList",JSON.stringify(waitingList));
				}
				}
			}else{
				$('#status_rede').text('Você está offline!');
			}

		hasChecklist();

		// Cria uma copia do objeto checkList
		// para checkNow, que é a checklist que esta sendo preenchida.
		checkNow = checklist;

	    $('#rootwizard').bootstrapWizard({
	        tabClass: 'nav nav-pills',
	        onNext: function(tab, navigation, index) {
	        	var errors = []
	            switch(index) {
				    case 1:

				    	var tipo_carga = $('#tipo_carga').val();
				    	var placa = $('#placa').val();
				    	if(tipo_carga == "0"){
				    		errors.push("Selecione o TIPO de carga");
				    	}
				    	if(placa == "0"){
				    		errors.push("Selecione A PLACA do veículo.");
				    	}
				    	checkNow.INFO.tipo_carga = tipo_carga
				    	checkNow.INFO.placa = placa;
				    	console.log(checkNow);
				        break;
				    case 2:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				    case 3:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				    case 4:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				    case 5:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
			        case 6:
			        	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				    case 7:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				    default:
				    	// Validações referente ao negócio da empresa devem ser adicionadas aqui
				        break;
				}

				if(errors.length > 0){
					var msg = ""
					for(i in errors){
						msg += errors[i]+"\n";
					}
					alert(msg);
					return false;
				}
				console.log(checkNow);
			}
	  });


	  //Pega o click de OK e preenche o JSON 
	  $('.option.ok').click(function(){
	  		var tag = $(this).attr('data-tag');
	  		$('.error_block.'+tag).hide();

	  		//marca opção
	  		$('button[data-tag="'+tag+'"]').removeClass('active');
	  		$(this).addClass('active');

	  		checkNow[tag].error = false;
	  		checkNow[tag].error_description = "N/A";
	  		checkNow[tag].correct = true;

	  })
	  //Decide o que deve ser feito com as informações da checklist
	  // no momento em que o usuário finaliza e clica em SALVAR
	  $('#salvar').click(function(){
	  	if(navigator.onLine) {
	  		
	  		//Se online adicionamos aqui um metodo POST na 
	  		//URL do backend desenvolvido em PHP

			alert('Chamada API será feita! Online.');
		}else{

			//Se offline apenas guardamos essa informação para envio futuro.

			alert('\n\n\nVocê está offline.\n\n\n Suas informações foram salvas \n\n\n Conecte-se para enviar as informações a central.');
			  	waitingList = JSON.parse(localStorage.waitingList);
			  	waitingList.itens.push(checkNow);
			  	console.log(waitingList);
			  	localStorage.setItem("waitingList",JSON.stringify(waitingList));
		}

	  })

	  //Pega o click de ERROR e preenche o JSON
	  //Generico, funciona pra qualquer elemento de checklist 
	  $('.option.error').click(function(){
	  		var tag = $(this).attr('data-tag');

	  		$('button[data-tag="'+tag+'"]').removeClass('active');
	  		$(this).addClass('active');

	  		checkNow[tag].error = true;
	  		checkNow[tag].error_description = "N/A";
	  		checkNow[tag].correct = false;
	  		$('.error_block.'+tag).show();
	  })

	  //Detecta a mudança de algum objeto de erro.
	  //Caso o usuario selecione uma opção e depois troque.
	  $('.error_description').change(function(){
	  	var tag = $(this).attr('data-tag');
	  	checkNow[tag].error_description = $(this).val();
	  	console.log('??')
	  	erroBlock = false;
	  	console.log(erroBlock);
	  })


	}); //Fim Document Ready


	// Verifica se no localStorage existe informações na lista de espera.
	// Se não existir criamos o elemento waitingList no localstorage, ele será
	// responsavel por  armazenas todas as checklist que estão na lisa de espera
	// para serem enviadas ao backend.

	function hasChecklist(){
		waitingList = localStorage.waitingList
		if(!waitingList){
			console.log('localStorage criado!')
			localStorage.setItem("waitingList",JSON.stringify({itens:[]}));
		}else{
			console.log('localStorage existente.');
			console.log(JSON.parse(waitingList));
		}
	}

	// De acordo com o tipo de carga as placas são exibidas.
	// As placas estão cadastradas no arquivo placa.json 
	// que estara em cache quando offline.

	function carrega_placas(){
		carga = $('#tipo_carga').val();
		$( "#placa" ).empty();
		var placas = []

		//Percorre todos os tipos de cargas
		for(i in tipos_carga){
			//Encontra o tipo selecionado
			if(tipos_carga[i].type == carga)
			{
				//obtem as placas
				for(k in tipos_carga[i].placas)
				{
					placas.push(tipos_carga[i].placas[k]);
				}

				var htmlOption = '<option class="placa_item" value="#PLACA#" > #PLACA# </option>';
				//constrói o HTML
				$('#placa').append('<option class="placa_item" value="0" selected="selected"> - Seleciona uma placa -  </option>')
				for(k in placas){
					var op = htmlOption.replace('#PLACA#',placas[k]);
					op = op.replace('#PLACA#',placas[k]);
					$('#placa').append(op)
				}
				$('#placa_input').fadeIn();
			}
		}
			 
	}
	
	</script>
</body>
</html>
